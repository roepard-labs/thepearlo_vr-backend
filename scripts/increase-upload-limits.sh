#!/bin/bash

##############################################################################
# Script: Aumentar LÃ­mites de Subida de Archivos en PHP
# DescripciÃ³n: Modifica php.ini para permitir uploads de hasta 50 MB
# Proyecto: HomeLab AR - Roepard Labs
# Uso: bash increase-upload-limits.sh
##############################################################################

set -e  # Salir si hay algÃºn error

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${BLUE}â•‘  ğŸ“¤ Aumentar LÃ­mites de Subida de Archivos en PHP        â•‘${NC}"
echo -e "${BLUE}â•‘  HomeLab AR - Roepard Labs                                â•‘${NC}"
echo -e "${BLUE}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

# Detectar ubicaciÃ³n de php.ini
echo -e "${YELLOW}ğŸ” Detectando ubicaciÃ³n de php.ini...${NC}"
PHP_INI_PATH=$(php --ini | grep "Loaded Configuration File" | awk '{print $4}')

# If there is no loaded php.ini (common inside Docker images), fall back
# to creating/using a file under conf.d/ (this is the canonical place to
# drop additional .ini snippets parsed by PHP SAPI like FPM).
if [ -z "$PHP_INI_PATH" ] || [ "$PHP_INI_PATH" == "(none)" ]; then
    echo -e "${YELLOW}âš ï¸  No se encontrÃ³ php.ini principal cargado â€” usando conf.d/uploads.ini (entorno container-friendly)${NC}"
    PHP_INI_PATH="/usr/local/etc/php/conf.d/uploads.ini"
    # Ensure dir exists
    if [ ! -d "$(dirname "$PHP_INI_PATH")" ]; then
        echo -e "${YELLOW}â„¹ï¸  Creando directorio: $(dirname "$PHP_INI_PATH")${NC}"
        mkdir -p "$(dirname "$PHP_INI_PATH")"
    fi
    # Create file if missing so update_php_config can edit it
    if [ ! -f "$PHP_INI_PATH" ]; then
        echo -e "${YELLOW}â„¹ï¸  Creando archivo: $PHP_INI_PATH${NC}"
        echo "; uploads configuration generated by increase-upload-limits.sh on $(date -u)" > "$PHP_INI_PATH"
    fi
fi

echo -e "${GREEN}âœ… php.ini encontrado: ${PHP_INI_PATH}${NC}"
echo ""

# Verificar permisos de escritura
if [ ! -w "$PHP_INI_PATH" ]; then
    echo -e "${RED}âŒ No tienes permisos de escritura en ${PHP_INI_PATH}${NC}"
    echo -e "${YELLOW}â„¹ï¸  Intenta ejecutar con sudo:${NC}"
    echo -e "${YELLOW}    sudo bash $0${NC}"
    exit 1
fi

# Crear backup del archivo que vayamos a editar (si existe)
BACKUP_PATH="${PHP_INI_PATH}.backup.$(date +%Y%m%d_%H%M%S)"
if [ -f "$PHP_INI_PATH" ]; then
    echo -e "${YELLOW}ğŸ’¾ Creando backup: ${BACKUP_PATH}${NC}"
    cp "$PHP_INI_PATH" "$BACKUP_PATH"
    echo -e "${GREEN}âœ… Backup creado exitosamente${NC}"
else
    echo -e "${YELLOW}â„¹ï¸  No existe un archivo para respaldar â€” se crearÃ¡ uno nuevo: ${PHP_INI_PATH}${NC}"
fi
echo ""

# Mostrar valores actuales
echo -e "${BLUE}ğŸ“Š Valores actuales de php.ini:${NC}"
echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
php -i | grep -E "upload_max_filesize|post_max_size|max_execution_time|max_input_time|memory_limit" | head -5
echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
echo ""

# FunciÃ³n para actualizar o agregar configuraciÃ³n
update_php_config() {
    local key=$1
    local value=$2
    local file=$3
    
    # Verificar si la directiva existe (comentada o no)
    if grep -q "^[;]*${key}" "$file"; then
        # Existe, actualizarla (descomentar si estÃ¡ comentada)
        sed -i "s|^[;]*${key}.*|${key} = ${value}|" "$file"
        echo -e "${GREEN}âœ… ${key} actualizado a ${value}${NC}"
    else
        # No existe, agregarla al final
        echo "${key} = ${value}" >> "$file"
        echo -e "${GREEN}âœ… ${key} agregado con valor ${value}${NC}"
    fi
}

# Aplicar configuraciones
echo -e "${BLUE}âš™ï¸  Aplicando nuevas configuraciones...${NC}"
echo ""

update_php_config "upload_max_filesize" "50M" "$PHP_INI_PATH"
update_php_config "post_max_size" "60M" "$PHP_INI_PATH"
update_php_config "memory_limit" "256M" "$PHP_INI_PATH"
update_php_config "max_execution_time" "300" "$PHP_INI_PATH"
update_php_config "max_input_time" "300" "$PHP_INI_PATH"

echo ""
echo -e "${GREEN}âœ… Todas las configuraciones aplicadas correctamente${NC}"
echo ""

# Verificar nuevos valores
echo -e "${BLUE}ğŸ“Š Nuevos valores de php.ini:${NC}"
echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
php -i | grep -E "upload_max_filesize|post_max_size|max_execution_time|max_input_time|memory_limit" | head -5
echo -e "${YELLOW}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${NC}"
echo ""

# Detectar servidor web y sugerir reinicio
echo -e "${BLUE}ğŸ”„ Detectando servidor web...${NC}"

if command -v systemctl >/dev/null 2>&1 && (systemctl is-active --quiet php-fpm || systemctl is-active --quiet php8.4-fpm); then
    echo -e "${YELLOW}âš ï¸  PHP-FPM detectado. Reiniciando servicio...${NC}"
    
    if systemctl is-active --quiet php8.4-fpm; then
        sudo systemctl restart php8.4-fpm && echo -e "${GREEN}âœ… PHP 8.4-FPM reiniciado${NC}" || echo -e "${RED}âŒ Error al reiniciar PHP-FPM${NC}"
    elif systemctl is-active --quiet php-fpm; then
        sudo systemctl restart php-fpm && echo -e "${GREEN}âœ… PHP-FPM reiniciado${NC}" || echo -e "${RED}âŒ Error al reiniciar PHP-FPM${NC}"
    fi
elif command -v systemctl >/dev/null 2>&1 && systemctl is-active --quiet nginx; then
    echo -e "${YELLOW}âš ï¸  Nginx detectado${NC}"
    echo -e "${YELLOW}â„¹ï¸  Reinicia Nginx si es necesario: sudo systemctl restart nginx${NC}"
elif command -v systemctl >/dev/null 2>&1 && systemctl is-active --quiet apache2; then
    echo -e "${YELLOW}âš ï¸  Apache detectado. Reiniciando servicio...${NC}"
    sudo systemctl restart apache2 && echo -e "${GREEN}âœ… Apache reiniciado${NC}" || echo -e "${RED}âŒ Error al reiniciar Apache${NC}"
else
    # No systemd available â€” common in containers. Try 'service' as fallback.
    if command -v service >/dev/null 2>&1; then
        echo -e "${YELLOW}âš ï¸  systemctl no encontrado, intentando 'service'...${NC}"
        if service php8.3-fpm restart >/dev/null 2>&1 || service php8.4-fpm restart >/dev/null 2>&1 || service php-fpm restart >/dev/null 2>&1; then
            echo -e "${GREEN}âœ… Servicio PHP-FPM reiniciado usando 'service'${NC}"
        else
            echo -e "${YELLOW}â„¹ï¸  'service' existe pero no reiniciÃ³ php-fpm automÃ¡ticamente. Si estÃ¡s en Docker, reinicia el contenedor (dokploy/reload) para aplicar cambios.${NC}"
        fi
    else
        echo -e "${YELLOW}â„¹ï¸  No se pudo reiniciar automÃ¡ticamente (no hay systemctl ni service).${NC}"
        echo -e "${YELLOW}â„¹ï¸  Si estÃ¡s usando contenedores (Docker/Dokploy) reinicia el contenedor o usa la opciÃ³n de reload/restart en tu plataforma (dokploy).${NC}"
        echo -e "${YELLOW}â„¹ï¸  TambiÃ©n puedes reiniciar php-fpm manualmente si conoces el PID del proceso (p. ej. 'ps aux | grep php-fpm' y reiniciar el proceso master).${NC}"
    fi
fi

echo ""
echo -e "${GREEN}â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—${NC}"
echo -e "${GREEN}â•‘  âœ… ConfiguraciÃ³n completada exitosamente                 â•‘${NC}"
echo -e "${GREEN}â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo ""

echo -e "${BLUE}ğŸ“ Resumen de cambios:${NC}"
echo -e "  ${GREEN}â€¢${NC} upload_max_filesize: ${GREEN}50M${NC}"
echo -e "  ${GREEN}â€¢${NC} post_max_size: ${GREEN}60M${NC}"
echo -e "  ${GREEN}â€¢${NC} memory_limit: ${GREEN}256M${NC}"
echo -e "  ${GREEN}â€¢${NC} max_execution_time: ${GREEN}300s${NC}"
echo -e "  ${GREEN}â€¢${NC} max_input_time: ${GREEN}300s${NC}"
echo ""

echo -e "${BLUE}ğŸ’¾ Backup guardado en:${NC}"
echo -e "  ${YELLOW}${BACKUP_PATH}${NC}"
echo ""

echo -e "${BLUE}ğŸ§ª Para probar los cambios:${NC}"
echo -e "  ${YELLOW}php -i | grep upload_max_filesize${NC}"
echo ""

echo -e "${BLUE}ğŸ”™ Para restaurar el backup:${NC}"
echo -e "  ${YELLOW}cp ${BACKUP_PATH} ${PHP_INI_PATH}${NC}"
echo ""

echo -e "${GREEN}Â¡Listo! Ahora puedes subir archivos de hasta 50 MB${NC}"
